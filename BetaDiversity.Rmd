---
title: "Calculating Beta Diversity"
output: html_notebook
---

## Beta Diversity

explanation


### Packages you will need for doing beta diversity:
```{r Loading packages}
setwd("~/Mote_Coral_Fall2020/microbes_pipeline")
library(phyloseq)
library(ggplot2)
library(vegan)
library(multcompView)
#... add any other standard packages.
```

### Load the file(s) you need
Phyloseq objects are a very useful way to contain all of the key items you need for microbiome analyses (OTU tables, sample data, and tax tables), as well as keeping your code cleaner, all without having to waste a lot of time loading in .csv files. Assuming they are saved as an .rds object in your working directory, you can load pre-made phyloseq objects into R using the readRDS() function. This function works just like the read.csv() function. All it requires is the name of the .rds object from your working directory in quotations.
```{r}
ps <- readRDS("examplePhyloseq.rds") #import the .rds phyloseq object made in the intro to phyloseq notebook
ps #confirm it worked
```


### Permanovas
##### what does it show:
A permanova, short for permutational multivariate analysis of variance, is a non-parametric multivariate test that compares groups of objects to each other. In microbiome analyses like this one, it is used to compare the contents of microbiomes between groups, the groups in this case being Region (Upper, Middle, and Lower Keys). The results of a permanova tell you whether or not your groups (i.e. Region) are statistically significantly different from each other. For a permanova to get more accurate results, you want to convert the data to Bray-Curtis Dissimilarity Distances. This is a distance metric that quantifies the dissimilarity between two groups, ranging from 0, where the groups are identical, to 1, where the groups have no similarities. 

##### adonis function- what goes in/out:
To run a permanova in R, use the adonis function from the package Vegan
in: For the adonis function, you need your phyloseq object and to know the name of the column in your metadata that the groups you are comparing come from (i.e. Region).

out: the adonis function prints the number of permutations as well as the degrees of freedom, Sums Of Squares, Mean Squares, F.Model, R2, and your p-value.
```{r}
df = as(sample_data(ps), "data.frame") #you need to convert it to a dataframe first
d = phyloseq::distance(ps, "bray") #convert abundance to bray curtis distances
df$Region <- as.factor(df$Region) #the recent R update has trouble with assigning proper formats to variables so this sets it as a factor (the proper format)
PERMANOVA <- adonis(d ~ Region, df) #run the permanova by region
PERMANOVA
```
This permanova tested for differences between regions and returned a p-value of 0.001. This means that there is a statistically significant difference between the microbiomes of the Upper, Middle, and Lower Keys.

### Multiple permanova
what is multiple permanova versus a normal permanova, bonferroni adjustment, what does it show, what goes in/out
```{r}
sampledf<-data.frame(sample_data(ps)) #convert to phyloseq object
sampledf$Region<-as.factor(sampledf$Region) #the recent R update has trouble with assigning proper formats to variables so this sets it as a factor (the proper format)
region.list<-levels(sampledf$Region) #make variable of list of levels (aka types) of region
region.list #confirm it worked
aovresults<-c() #set up variable for later use
pvals<-c() #set up variable for later use
locations<-c() #set up variable for later use
for (i in 1:length(region.list)){ #for loop of the length of the region list, in this case 3
  region.leftout<-region.list[i] #set one region to region.leftout
  ps_sub<-subset_samples(ps,Region!=region.leftout) #subset the phyloseq object so it includes 2 of the three regions (aka all but the region.leftout)
  d.sub<-phyloseq::distance(ps_sub, "bray") #permanova wants distances in bray curtis, convert to bray curtis
  df.new<-subset(sampledf,subset=Region!=region.leftout) #make dataframe of sample data for only the 2 included regions
  PERM<-adonis(d.sub~Region,df.new) #run permanova on the 2 regions
  print(PERM) #see results
  pvals<-c(pvals,PERM$aov.tab$'Pr(>F)'[1]) #this saves the p-values that were outputted. to confirm what this data calls its p-values, run a permanova and save the output to do str(output) to see what it call's the p-values that it outputs.
  aovresults<-rbind(aovresults,PERM$aov.tab) #add/save current aov results
  loc.sub<-region.list[-i]
  locations<-rbind(locations,c(loc.sub)) #add/save list of current locations used
}
aovresults #see overall aov results
combinedtest<-cbind(locations,pvals) #combine location and p-value data
mult_perm<-data.frame(combinedtest) #save p-values to a dataframe
#mult_perm
mult_perm$pvaladj<-p.adjust(mult_perm$pvals,method="bonferroni") #use the bonferroni adjustment on the p-values and save it
mult_perm #view results
```
interpret?

### NMDS plots
#### what is an NMDS plot and what does it show?
An NMDS, aka a Non-metric Multidimensional Scaling plot, graphs samples by their pairwise dissimilarities. These plots show the similarity/dissimilarity between samples. These plots can also show the grouping of samples by their similarity. Samples within the same circle, called a 95% confidence ellipse, have a 95% likelihood of being in the same group (i.e. Lower, Middle, or Upper Keys). These plots also work better if you convert your distances to Bray-Curtis distances, which is built in to the plot_ordination function we will be using.
##### what goes in/out
In R, we are going to use the plot_ordination function from the package Phyloseq. 
in: For plot_ordination all you need is your phyloseq object and to know what you want to color/look at grouping by (e.g. Region).
out: plot_ordination returns the stress values of every solution it tries to run, as well as the NMDS plot for the best solution.
```{r}
pMDS <- plot_ordination(ps, ordinate(ps, "NMDS","bray", autotransform = FALSE, parallel = 48, trymax = 10^4, maxit = 10^4), color = "Region") +  scale_colour_manual(values=c("Lower Keys" = "red", "Middle Keys" = "green", "Upper Keys" = "blue"))   + geom_point(size=2) + theme_set(theme_bw()) #the only things to adjust for other datasets here is the color = "Region" and the scale_color_manual(). you could also leave them out and R will not color or just leave out the scale_color_manual() and R will choose the colors
print(pMDS)+stat_ellipse(aes(fill=Region)) #print the plot with 95% confidence ellipses
```
This NMDS graph shows 3 separate groups, one for each region, where the Lower and Upper Keys are the most similar to the Middle Keys and the most different from each other. This supports the permanova's findings that the Acer microbiomes are different by region.

### Betadisper
what is betadisper, what does it show, what goes in/out
```{r}
sampledf<-data.frame(sample_data(ps))
sampledf$Region <- as.factor(sampledf$Region)
d_mat<-phyloseq::distance(ps, "bray")
g_mod<-with(sampledf,betadisper(d_mat,Region))
boxplot(g_mod)
mod.tukey<-TukeyHSD(g_mod)
mod.tukey
labels <- multcompLetters(mod.tukey$group[, "p adj"])$Letters # Fix the order of the labels
(labels <- labels[order(names(labels))])
boundaries<-boxplot(g_mod, ylim = c(0,.25))
boundaries 
text( x=c(1:3),y=boundaries$stats[nrow(boundaries$stats),] + 0.05, labels,col="red")
```
interpret?
