---
title: "Getting started with Phyloseq"
output: html_notebook
---

## What is phyloseq?

explanation of package

https://www.rdocumentation.org/packages/phyloseq/versions/1.16.2 <- link to rdocumentation/list of functions in the phyloseq package

Packages you will need for doing basic microbial analyses:
```{r}
library(phyloseq)
library(ggplot2)
library(vegan)
#... add any other standard packages.
```

## Microbial Data

### File structures

### Explanation of practice dataset we will use and getting it into R

```{r Make the components of the phyloseq object}
otudf <- read.csv("acer_otu_table.csv",row.names = 1) #loads csv file into R as a dataframe
#row.names = 1 is important, it sets the table's row names to the sample ID or taxa if taxa are rows so that it can be come a numeric matrix required for otu_table()
otumat<- as.matrix(otudf) #otu_table() doesn't like dataframes so you need to convert to a matrix
otu <- otu_table(otudf, taxa_are_rows = FALSE) #makes data into an otu table object
#be sure to confirm whether or not your taxa are rows or columns, in this case they are rows

taxdf <- read.csv("acer_tax_table.csv", row.names = 1) #loads csv file into R as a dataframe
#row.names = 1 is important, it sets the table's row names to the ASV ID, otherwise, it gets confused and sets the ID to the kingdom row
taxmat <- as.matrix(taxdf) #tax_table needs matrices not dataframes 
tax <- tax_table(taxmat) #makes data into a taxonomy table object

samdf <- read.csv("acer_sample_data.csv",row.names = 1) #loads csv file into R as a dataframe
#row.names = 1 is important because without it, r will not be able to match the sample names from the sample data to the otu table when building the phyloseq object
sample <- sample_data(samdf) #makes a sample data table
#note: sample data does NOT need to be a matrix to compile
```

### Making a Phyloseq object
what goes in... what comes out...
```{r Making the phyloseq object}
ps <- phyloseq(otu, tax, sample) #make the phyloseq object from the components made in the last chunk
ps #view the phyloseq object
#this object should have 1195 taxa and 64 samples
head(sample_data(ps)) #confirm that it worked; if it did, you should see the first few rows of the phyloseq object's sample data
```

### Exploring your Phyloseq object

```{r}
#to view the sample data
sample_data(ps)

#to view the taxonomy table
tax_table(ps) #this theoretically works but its harder to read
data.frame(tax_table(ps)) #this is the better way to view the taxonomy table, since it is easier to read

#to view the otu table
otu_table(ps) #this doesn't work, it will give you the number of taxa and samples so if you need that info this is a good way to go, but it doesn't actually show the otu table
data.frame(otu_table(ps)) #this is how you actually view the otu table data
```

### Filtering, subsetting, and pruning your phyloseq object

```{r Filtering and pruning}
#You can filter taxa to remove the smallest abundances with the line below
physeq.f<-filter_taxa(ps, function(x) sum(x >= 100) > (0.01*length(x)), prune = TRUE) #filter out super small numbers
physeq.f #FIX????

#You can also convert your data from raw abundance data to relative abundance data
physeq.f.ra <- transform_sample_counts(ps, function(x) x*100/sum(x)) #transform to relative abundance from raw abundance
rowSums(data.frame(otu_table(physeq.f.ra)))#if the line above worked right, all of the row sums should be 100

#You can also merge samples by a variable in the sample data, i.e. Region
psregmerge <- merge_samples(ps,"Region")#the second part is the variable name be sure to spell it correctly, capitalize correctly, and keep it in quotations, if it doesn't match its name in your sample data, then this line WONT work
#Do not let the warning message from merge_samples() alarm you, it is not harmful
data.frame(otu_table(psregmerge)) #if done right, this data is now combines so there is 1 abundance row in the otu table for each region
```
##### subsetting
complete list of R operators here: https://www.statmethods.net/management/operators.html
```{r Subsetting your data}
#subsetting your data by info from the sample data, using ==
psup <- subset_samples(ps, Region=="Upper Keys") #this subsets your data by region equals Upper Keys, so you only get Upper Keys
psup #this object should have 1195 taxa and 13 samples
psmid <- subset_samples(ps, Region=="Middle Keys") #this subsets your data by region equals Middle Keys, so you only get Middle Keys
psmid #this object should have 1195 taxa and 15 samples
pslow <- subset_samples(ps, Region=="Lower Keys") #this subsets your data by region equals Lower Keys, so you only get Lower Keys
pslow #this object should have 1195 taxa and 36 samples

####subsetting you data by info from the sample data, using other boolean operators##########
psnolow <- subset_samples(ps, Region!="Lower Keys") #this uses the != operator (AKA not equal to) to subset for everything except the lower keys
sample_data(psnolow)

#you can subset by more than just equal to or not equal to
pslatlong <- subset_samples(ps, Lat>=24.5&&Long<=81.5) #this uses the && operator (AKA and) to subset by Lat and Long, this also uses the >= (AKA greater than or equal to) to subset Lat so it only includes latitudes >= 24.5, and it uses <= (AKA less that or equal to) to subset Long so it only includes longitudes <= 81.5
sample_data(pslatlong)

#you can also subset by or not just and
psuplow <- subset_samples(ps, Region=="Upper Keys"|Region=="Lower Keys") #this uses the | operator (AKA or) to subset, choosing any samples that are upper keys OR lower keys 
#this is different than && because && requires both halves to be true, but for | one half or the other can be true not necessarily both
sample_data(psuplow)

#subsetting your data by taxonomy
psrick <- subset_taxa(ps, Order=="Rickettsiales")
psrick
data.frame(tax_table(psrick))
```


### save.rds()
```{r}

```


