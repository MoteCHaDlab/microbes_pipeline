---
title: "Relative Abundance and Bubble plots"
output: html_notebook
---

# Relative Abundance and Bubble Plots
###Relative abundance plots vs bubble plots:
Both of these plots show the relative abundance of at least some taxa. Beyond the obvious difference of one being a stacked barplot and the other being a bubble plot, the key difference between the two is that relative abundance plots show the whole story of what is present in the samples, whereas bubble plots only show the key taxa, usually the significant taxa pulled out by a simper, ancom, or corncob analysis. Relative abundance plots are most useful when you want to look at compositional differences between the samples, they can also give a very rough sense of the diversity in your samples. Bubble plots are most useful when you want to look at differences in abundance of key taxa.

## load packages
```{r}
library("ggplot2")
library("phyloseq")
library("RColorBrewer")
library("reshape2")
library("nlme")
library("dplyr")
library("compositions")
library("tidyverse")
```

## load the files needed
```{r}
ps <- readRDS("examplePhyloseq.rds") #import the .rds phyloseq object made in the intro to phyloseq notebook
ps #confirm it worked
```

## Relative Abundance plots
What goes in: a phyloseq object
What goes out: a relative abundance plot
```{r}
physeq.f <- filter_taxa(ps, function(x) sum(x >= 100) > (0.01*length(x)), prune = TRUE) #filter out super small numbers
physeq.f #check it worked
head(sample_data(physeq.f)) #just checking it worked
head(tax_table(physeq.f)) #just checking it worked
physeq.f.ra <- transform_sample_counts(physeq.f, function(x) x*100/sum(x)) #transform data from raw abundance to relative abundance
physeq.f.ra.ord <- tax_glom(physeq.f.ra, "Class",NArm=FALSE) #merge taxa on the class level, so that there's only 1 value for each Class CHANGE HERE IF YOU WANT A DIFFERENT TAXONOMIC LEVEL
propData <- as.data.frame((otu_table(physeq.f.ra.ord))) #make otu table a dataframe
plotDF1 <- propData %>% #within the propData variable
  rownames_to_column(var="taxa") %>% 
  melt() %>% 
  magrittr::set_names(c("sample", "taxa", "relab"))
head(plotDF1)#just checking it worked
taxonomy.2 <- tax_table(physeq.f) %>%
  as.data.frame() %>%
  rownames_to_column(var="taxa")
head(taxonomy.2)#just checking it worked
head(plotDF1)#just checking it worked
plotDF1 <- left_join(plotDF1, taxonomy.2, by="taxa") %>% select(taxa, sample, relab, Class) #combine dataframes merging by taxa, with the columns listed in select. ALSO CHANGE CLASS HERE IF YOU WANT A DIFFERENT TAXONOMIC RANK
head(plotDF1)#just checking it worked
length(levels(factor(plotDF$Class))) #check how many classes there are
mycolors <- c("black","red","orange","yellow","green","blue","magenta","darkorchid4") #make a list of colors the same length as the number of classes
names(mycolors)<-levels(factor(plotDF$Class)) #set the colors to an associated taxonomic rank. ALSO CHANGE CLASS HERE IF YOU WANT A DIFFERENT TAXONOMIC RANK
mycolors #confirm it worked
sampdata<-data.frame(sample_data(physeq.f)) #make dataframe of the sample data
metadata.2 <- sampdata %>%
  rownames_to_column(var="sample")
metadata.2
plotDF1 <- left_join(plotDF1, metadata.2, by="sample") #combine plotDF1 and metadata.2 by sample name
head(plotDF1) #just checking it worked
length(levels(factor(plotDF1$Class))) #check how many classes there are. ALSO CHANGE CLASS HERE IF YOU WANT A DIFFERENT TAXONOMIC RANK
plotDF1$Class<-factor(plotDF1$Class) #make class a factor. ALSO CHANGE CLASS HERE IF YOU WANT A DIFFERENT TAXONOMIC RANK
plotDF1$sample<-factor(plotDF1$sample) #make sample a factor
plotDF1$Site<-factor(plotDF1$Region) #make Region a factor
ggplot(plotDF1, aes(x=plotDF1$sample, relab, fill=Class)) + #make a plot with genotype/sample name on the x-axis, relative abundance on the y-axis, and color filled by Class. ALSO CHANGE CLASS HERE IF YOU WANT A DIFFERENT TAXONOMIC RANK
  geom_bar(stat="identity", position = "stack") + #make it a barplot with classes stacked on top of each other
  theme(axis.text.x = element_text(angle = 90,size = 6.5)) + #set x-axis labels to be oriented vertically, and set the size of the text to 10
  scale_fill_manual(values = mycolors,limits = levels(plotDF$Class)) + #set the colors being filled in by class to the mycolors variable made earlier
  facet_grid(~Region,space="free_x",scales="free_x",drop=TRUE) + #facet wrap (separate out) by Region
  theme(legend.title = element_text(size = 8),legend.text = element_text(size = 6),legend.position = "bottom") #set legent title size to 8 and legend text size to 6
```


## Bubble plots
2 types used in this r-notebook: bubble plots with ASVs on the y-axis and bubble plots with a taxonomic rank on the y-axis

### Bubble plot with ASVs on the y-axis
What goes in: a phyloseq object
What goes out: a bubble plot where significant ASVs is the y-axis
ASVs pulled from simper
```{r}
physeq.f.ra <- transform_sample_counts(ps, function(x) x*100/sum(x)) #switch to relative abundance from raw abundance
p<-merge_samples(physeq.f.ra,"Region") #merge by region
o<-otu_table(p) #make variable of p's otu table
rowSums(otu_table(physeq.f.ra)) #confirm that all of the rows add up to 100 (this makes sure that the data is actually in relative abundance format)
propData <- as.data.frame(o) #make otu table a dataframe
t<-data.frame(cbind(levels(as.factor(sample_data(ps)$Region)))) #make dataframe with region
t <-cbind(t,propData$ASV_2,propData$ASV_3,propData$ASV_4) #add the abundance data of the 3 ASVs from the simper to the dataframe 
colnames(t)<-c("Region","ASV_2","ASV_3","ASV_4") #set the column names
pcm = melt(t, id = c("Region")) #convert data frame from a "wide" format to a "long" format
xx = ggplot(pcm, aes(x = Region, y = variable,fill=variable)) + #make plot with Region as the x-axis, the significant ASVs as the y-axis, and color filled by the significant ASVs
  geom_point(aes(size = as.numeric(value)), alpha = 0.75, shape = 21) +  #make bubble plot format where the size of the bubble is the relative abundance
  scale_size_continuous(limits = c(0.000001, 100), range = c(.5,10), breaks = c(1,25,50,75)) + #set bubble size scaling
  labs( x= "", y = "", size = "Abundance", fill = "Significant ASVs")  + #set labels for size legend and color legend
  theme(legend.key=element_blank(), axis.text.x = element_text(colour = "black", size = 12, face = "bold", angle = 90, vjust = 0.3, hjust = 1), axis.text.y = element_text(colour = "black", face = "bold", size = 11), legend.text = element_text(size = 10, face ="bold", colour ="black"), legend.title = element_text(size = 12, face = "bold"), panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2), legend.position = "right") + #set various text sizes and colors, as well as legend position
  scale_y_discrete(limits = rev(levels(pcm$variable))) #set y-scale limits to significant ASVs
xx #print plot
```


### Bubble plot with taxonomic rank on the y-axis
What goes in: a phyloseq object
What goes out: a bubble plot where Class is the y-axis
```{r}
ps1<-merge_samples(ps,"Region") #merge by Region
physeq.f.ra <- transform_sample_counts(ps1, function(x) x*100/sum(x)) #transform to relative abundance from raw abundance
taxa<-c("ASV_2","ASV_3","ASV_4","ASV_6") #make list of ASVs to include
ps_difabund<-subset_taxa(physeq.f.ra,rownames(tax_table(physeq.f.ra)) %in% taxa) #subset your relative abundance phyloseq object by those taxa 
rowSums(otu_table(physeq.f.ra)) #making sure it worked by getting the sums of each row, should all be 100
physeq.f.ra.ord <- tax_glom(ps_difabund, "Class",NArm=FALSE)#glom to order, IF YOU WANT TO CHANGE TAXONOMIC RANK DO SO HERE
propData <- as.data.frame((otu_table(physeq.f.ra.ord))) #make relative abundance otu into a dataframe
plotDF1 <- propData %>%
  rownames_to_column(var="taxa") %>%
  melt() %>%
  magrittr::set_names(c("sample", "taxa", "relab"))
head(plotDF1)#just checking it worked
taxonomy.2 <- tax_table(physeq.f.ra.ord) %>%
  as.data.frame() %>%
  rownames_to_column(var="taxa")
head(taxonomy.2)#just checking it worked
head(plotDF1)#just checking it worked
plotDF1 <- left_join(plotDF1, taxonomy.2, by="taxa") %>% select(taxa, sample, relab, Class) #combine dataframes by taxa. IF YOU WANT TO CHANGE TAXONOMIC RANK DO SO HERE
head(plotDF1)#just checking it worked
sampdata<-data.frame(sample_data(physeq.f.ra.ord)) #make a dataframe of the sample data
metadata.2 <- sampdata %>%
  rownames_to_column(var="sample")
metadata.2 #check it worked
plotDF1 <- left_join(plotDF1, metadata.2, by="sample") #combine dataframes by Region
head(plotDF1)#just checking it worked
length(levels(factor(plotDF1$Class))) #check the number of classes
plotDF1$Class<-factor(plotDF1$Class) #set Class to a factor format
plotDF1$sample<-factor(plotDF1$sample) #set sample to a factor format
plotDF1$taxa<-as.factor(plotDF1$taxa) #set taxa to a factor format
bubbleclass = ggplot(plotDF1, aes(x = sample, y = Class, fill=plotDF1$taxa)) + #make a plot with Region on the X-axis, Class on the y-axis, and color filled by ASV
  geom_point(aes(size = as.numeric(relab)), alpha = 0.75, shape = 21) + #make the plot a bubble plot with bubble size as relative abundance
  scale_size_continuous(limits = c(0.000001, 100), range = c(.5,10), breaks = c(1,25,50,75)) + #set continuous scaling for bubble size
  labs( x= "", y = "", size = "Relative Abundance", fill = "Significant ASVs")  + #make legend labels
  theme(legend.key=element_blank(), axis.text.x = element_text(colour = "black", size = 12, face = "bold", angle = 90, vjust = 0.3, hjust = 1), axis.text.y = element_text(colour = "black", face = "bold", size = 8), legend.text = element_text(size = 10, face ="bold", colour ="black"), legend.title = element_text(size = 12, face = "bold"), panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2), legend.position = "right") + #set various text sizes and the legend position
  scale_y_discrete(limits = rev(levels(plotDF1$Class))) #set y limits to the types of Classes in this plot
bubbleclass #print plot
```
The blank label is an unclassified proteobacteria. It is blank because we do not know its classification below proteobacteria
